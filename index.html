<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Anonymous</title>
    <link rel="stylesheet" href="search.css">
</head>
<body>
    <section id="chat-container">
        <div id="title-text">Searching...</div>
        <div id="searchImgCon">
            <img src="earth.png" id="searchImg" alt="search-img">
        </div>
        <div id="text-div">
            <div id="search-text1">Choose a gender to start searching</div>
            <div id="search-text">Searching for a partner...</div>
            <div id="search-text2">Please wait...</div>
            <div id="search-text3">Looking for the right person</div>
            <div id="search-text4">Over <div id="totalOnline"></div> people online</div>
        </div>
        <div id="gender-div">
            <div id="gender-man" class="gender-option" data-gender="man" onclick="selectGender('man')">
                Man &#128104; <span id="check-man" style="display: none;">✔️</span>
            </div>
            <div id="gender-woman" class="gender-option" data-gender="woman" onclick="selectGender('woman')">
                Woman &#128105; <span id="check-woman" style="display: none;">✔️</span>
            </div><br><br>
        </div>
    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getDatabase, ref, set, onDisconnect, onValue, update } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDwKsNlw7wUDyQ_yEUhpYZdHIEnWFqQVyc",
            authDomain: "gyfp-48c48.firebaseapp.com",
            databaseURL: "https://gyfp-48c48-default-rtdb.firebaseio.com",
            projectId: "gyfp-48c48",
            storageBucket: "gyfp-48c48.appspot.com",
            messagingSenderId: "1098492817072",
            appId: "1:1098492817072:web:19ffb2510028ad75bf1575"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        let user = null;
        let selectedGender = null;
        let searchTimer;
        let isSearching = false;

        function saveUserGender() {
            if (selectedGender && user) {
                const userRef = ref(database, 'online/' + user.uid);
                set(userRef, {
                    uid: user.uid,
                    gender: selectedGender,
                    busy: false // Make sure the user is not busy initially
                });
                onDisconnect(userRef).remove();
            }
        }

        onAuthStateChanged(auth, (currentUser) => {
    if (currentUser) {
        user = currentUser;

        // Check if the user is already part of a chat only after selecting gender
        if (selectedGender) {
            const chatRef = ref(database, `chats`);
            onValue(chatRef, (snapshot) => {
                const chatData = snapshot.val();
                if (chatData) {
                    // Check if the current user is part of any chat
                    for (let chatKey in chatData) {
                        if (chatKey.includes(user.uid)) {
                            // Redirect to the chat if the user is in a chat
                            const matchedUid = chatKey.replace(user.uid, '').replace('Chat', '');
                            // Check if the matched user is online in the "online" node
                            const matchedUserRef = ref(database, `online/${matchedUid}`);
                            onValue(matchedUserRef, (snapshot) => {
                                const matchedUserData = snapshot.val();
                                if (matchedUserData) {
                                    // If matched user is online, redirect to the chat
                                    window.location.href = `chat.html?chat=${user.uid}%20${matchedUid}`;
                                } else {
                                    // Matched user is offline, do not redirect
                                    console.log('Matched user is offline. No redirection.');
                                }
                            });
                            return; // Exit after checking and potentially redirecting
                        }
                    }
                }
            });

            // Proceed with the search process if no chat found
            saveUserGender();
            findMatch(); // Call the function to find a match
        }
    } else {
        // Sign in anonymously if not authenticated
        signInAnonymously(auth).catch((error) => {
            console.error("Error signing in anonymously: ", error);
        });
    }
});

        const genderOptions = document.querySelectorAll('.gender-option');

        window.selectGender = function(gender) {
    selectedGender = gender;
    genderOptions.forEach(option => {
        const checkMark = option.querySelector('span');
        if (option.dataset.gender === gender) {
            checkMark.style.display = 'inline';
        } else {
            checkMark.style.display = 'none';
        }
    });

    // Hide the gender selection message after a gender is selected
    document.getElementById('search-text1').style.display = 'none'; // Hide the "Choose a gender" text
    
    // Show the searching message
    document.getElementById('search-text').style.display = 'block'; // Show "Searching for a partner..."
    document.getElementById('search-text2').style.display = 'none';  // Hide "Please wait..."
    document.getElementById('search-text3').style.display = 'none';  // Hide "Looking for the right person"
    document.getElementById('search-text4').style.display = 'none';  // Hide "Over <number> people online"

    startSearchCycle(); // Start the search cycle if a gender is selected
}

        function startSearchCycle() {
            document.getElementById('search-text').style.display = 'block'; // "Searching for a partner..."
            document.getElementById('search-text2').style.display = 'none';
            document.getElementById('search-text3').style.display = 'none';
            document.getElementById('search-text4').style.display = 'none';

            let counter = 0;
            let elapsedTime = 0; // Track elapsed time
            const messages = ['searching', 'looking', 'online'];

            searchTimer = setInterval(() => {
                if (elapsedTime < 5) {
                    // Cycle through messages
                    switch (counter) {
                        case 0:
                            document.getElementById('search-text').style.display = 'block';
                            document.getElementById('search-text3').style.display = 'none';
                            document.getElementById('search-text4').style.display = 'none';
                            break;
                        case 1:
                            document.getElementById('search-text').style.display = 'none';
                            document.getElementById('search-text3').style.display = 'block';
                            document.getElementById('search-text4').style.display = 'none';
                            break;
                        case 2:
                            document.getElementById('search-text').style.display = 'none';
                            document.getElementById('search-text3').style.display = 'none';
                            document.getElementById('search-text4').style.display = 'block';
                            break;
                    }
                    counter = (counter + 1) % messages.length;
                    elapsedTime++;
                } else {
                    document.getElementById('search-text2').style.display = 'block'; // Show "Please wait..."
                    document.getElementById('search-text').style.display = 'none';
                    document.getElementById('search-text3').style.display = 'none';
                    document.getElementById('search-text4').style.display = 'none';

                    clearInterval(searchTimer); // Stop cycling texts

                    // Set a timeout to reset after 10 seconds if no match is found
                    setTimeout(() => {
                        resetSearch();
                    }, 1);
                }
            }, 5000); // Update every 5 seconds
        }

        function findMatch() {
            const onlineRef = ref(database, 'online');
            onValue(onlineRef, (snapshot) => {
                const onlineUsers = snapshot.val();
                if (onlineUsers) {
                    const usersArray = Object.values(onlineUsers);
                    const oppositeGender = selectedGender === 'man' ? 'woman' : 'man';
                    const availableUsers = usersArray.filter(user => user.gender === oppositeGender && !user.busy);

                    if (availableUsers.length > 0) {
                        // Loop until a non-busy user is found
                        let matchedUser = null;
                        let attempts = 0; // To avoid infinite loop

                        while (matchedUser === null && attempts < availableUsers.length) {
                            const randomIndex = Math.floor(Math.random() * availableUsers.length);
                            matchedUser = availableUsers[randomIndex];

                            if (matchedUser.busy) {
                                // If the user is busy, reset matchedUser and try again
                                matchedUser = null;
                            }

                            attempts++;
                        }

                        if (matchedUser !== null) {
                            // Mark both users as busy and matched
                            const updates = {};
                            updates[`online/${user.uid}/matched`] = matchedUser.uid;
                            updates[`online/${matchedUser.uid}/matched`] = user.uid;
                            updates[`online/${user.uid}/busy`] = true;
                            updates[`online/${matchedUser.uid}/busy`] = true;

                            update(ref(database), updates);

                            console.log('Match found with:', matchedUser.uid);
                            alert('Match found with: ' + matchedUser.uid);

                            // Stop the search and clear the timer
                            clearInterval(searchTimer);
                        } else {
                            console.log('No available users. Searching continues...');
                        }
                    } else {
                        console.log('No users found! Searching continues...');
                    }
                } else {
                    console.log('No users are online at the moment! Searching continues...');
                }
            });
        }

        function resetSearch() {
            console.log('No match found. Resetting search.');

            // Reset user status in Firebase
            const userRef = ref(database, 'online/' + user.uid);
            set(userRef, null).then(() => {
                // Allow the user to search again
                selectedGender = null;

                // Reset UI
                document.getElementById('gender-div').style.display = 'block'; // Show gender selection
                document.getElementById('search-text1').style.display = 'block'; // Show "Choose a gender"
                document.getElementById('search-text').style.display = 'none';
                document.getElementById('search-text2').style.display = 'none';
                document.getElementById('search-text3').style.display = 'none';
                document.getElementById('search-text4').style.display = 'none';
            });
        }
    </script>
</body>
</html>