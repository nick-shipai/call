<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Random Video Call</title>
  <style>
    #local-video, #remote-video {
      width: 45%;
      height: auto;
      margin: 5%;
    }
    #container {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin-top: 50px;
    }
    button {
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>

  <h2>Random Video Call</h2>
  <div id="container">
    <video id="local-video" autoplay muted></video>
    <video id="remote-video" autoplay></video>
  </div>
  <button id="start-call">Start Call</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDwKsNlw7wUDyQ_yEUhpYZdHIEnWFqQVyc",
      authDomain: "gyfp-48c48.firebaseapp.com",
      databaseURL: "https://gyfp-48c48-default-rtdb.firebaseio.com",
      projectId: "gyfp-48c48",
      storageBucket: "gyfp-48c48.appspot.com",
      messagingSenderId: "1098492817072",
      appId: "1:1098492817072:web:19ffb2510028ad75bf1575"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);
    const localVideo = document.getElementById('local-video');
    const remoteVideo = document.getElementById('remote-video');
    const startCallButton = document.getElementById('start-call');
    
    let localStream;
    let peerConnection;
    let remoteUserId;
    let localUserId = auth.currentUser?.uid;

    // Handle user authentication
    onAuthStateChanged(auth, user => {
      if (user) {
        console.log('User authenticated:', user.uid);
        localUserId = user.uid;
        const userRef = ref(database, 'users/' + user.uid);
        set(userRef, { status: 'active' }); // Mark user as active
      } else {
        // Sign in anonymously for demo purposes
        signInAnonymously(auth).catch(error => {
          console.error('Error signing in:', error);
        });
      }
    });

    // Fetch a random active user
    function getRandomUser() {
      const usersRef = ref(database, 'users');
      onValue(usersRef, snapshot => {
        const users = snapshot.val();
        const activeUsers = [];
        for (const userId in users) {
          if (users[userId].status === 'active' && userId !== localUserId) {
            activeUsers.push(userId);
          }
        }
        if (activeUsers.length > 0) {
          remoteUserId = activeUsers[Math.floor(Math.random() * activeUsers.length)];
          console.log('Random user for call:', remoteUserId);
          startCall(remoteUserId);
        } else {
          alert('No active users available.');
        }
      });
    }

    // Initialize video call with WebRTC
    async function startCall(remoteUserId) {
      try {
        // Get local media stream
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;

        // Create peer connection
        peerConnection = new RTCPeerConnection();

        // Add local stream tracks to peer connection
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        // When remote stream is received, show it in the remote video
        peerConnection.ontrack = event => {
          remoteVideo.srcObject = event.streams[0];
        };

        // Setup ICE candidate handling
        peerConnection.onicecandidate = event => {
          if (event.candidate) {
            // Send ICE candidate to remote user through Firebase
            const iceCandidateRef = ref(database, `iceCandidates/${remoteUserId}`);
            set(iceCandidateRef, { candidate: event.candidate });
          }
        };

        // Create offer
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);

        // Send offer to the remote user
        const callRef = ref(database, 'calls/' + remoteUserId);
        set(callRef, { offer: offer.sdp, from: localUserId });

        // Listen for the answer from the remote user
        const callAnswerRef = ref(database, 'calls/' + localUserId);
        onValue(callAnswerRef, snapshot => {
          const callData = snapshot.val();
          if (callData && callData.answer) {
            const answer = new RTCSessionDescription({ type: 'answer', sdp: callData.answer });
            peerConnection.setRemoteDescription(answer);
          }
        });

        // Listen for ICE candidates from the remote user
        const remoteIceCandidateRef = ref(database, `iceCandidates/${localUserId}`);
        onValue(remoteIceCandidateRef, snapshot => {
          const iceCandidateData = snapshot.val();
          if (iceCandidateData && iceCandidateData.candidate) {
            const candidate = new RTCIceCandidate(iceCandidateData.candidate);
            peerConnection.addIceCandidate(candidate);
          }
        });

      } catch (error) {
        console.error('Error starting call:', error);
      }
    }

    // Handle start call button click
    startCallButton.addEventListener('click', () => {
      getRandomUser(); // Get a random active user when the button is clicked
    });

  </script>
</body>
</html>
